import React, {Component} from 'react';
import {Link} from 'react-router-dom';
import ShowObject from "./ShowObject";

import {FontAwesomeIcon} from '@fortawesome/react-fontawesome'

import 'brace/mode/text';
import 'brace/theme/github';
import 'brace/ext/searchbox';

import api from "@malwarefront/api";
import { ErrorBoundary, Identicon, HexView } from "@malwarefront/ui";

class SamplePreviewPresenter extends Component {
    handleMalwareDownload = async (event) => {
        event.preventDefault();
        let response = await api.requestFileDownload(this.props.sha256)
        window.location.href = api.getApiForEnvironment().replace(/\/$/g, '') + response.data.url;
    };

    render() {
        return (
        <div>
            <div className="card-header" style={{wordBreak: "break-all"}}>
                <div className="media">
                    <div className="align-self-center mr-3">
                        <Identicon hash={this.props.md5} size="45" />
                    </div>
                    <div className="align-self-center media-body">
                        <h5 className="mt-0">{this.props.humanhash}</h5>
                    </div>
                    <div className="ml-3">
                        <Link to={`/preview/${this.props.mode === "raw" ? "hex" : "raw"}/${this.props.sha256}`}>
                            <button className="btn btn-primary" style={{"marginRight": "8pt"}}>
                                <FontAwesomeIcon icon={this.props.mode === "hex" ? "toggle-on" : "toggle-off"} pull="left" size="x"/>
                                Hex mode
                            </button>
                        </Link>
                        <button onClick={this.handleMalwareDownload} target="_self" className="btn btn-primary"
                                style={{"marginRight": "8pt"}}>
                            <FontAwesomeIcon icon="download" pull="left" size="x"/>
                            Download sample
                        </button>
                        <Link to={`/sample/${this.props.sha256}`}>
                            <button className="btn btn-danger" style={{"marginRight": "8pt"}}>
                                <FontAwesomeIcon icon="times" pull="left" size="x"/>
                                Close
                            </button>
                        </Link>
                    </div>
                </div>
            </div>
            <div>
                <HexView content={this.props.content} mode={this.props.mode}/>
            </div>
        </div>)
    }
}

class ShowSamplePreview extends Component {
    state = {
        error: null,
        file: {
            children: [],
            mode: "raw"
        }
    };

    async updateSample() {
        try {
            let fileId = this.props.match.params.hash;
            let fileResponse = await api.getObject("file", fileId);
            let fileUrlResponse = await api.requestFileDownload(fileId)
            let fileContentResponse = await api.axios.get(fileUrlResponse.data.url)
            let file = fileResponse.data;
            file.content = fileContentResponse.data;
            file.mode = this.props.match.params.mode;
            this.setState({file})
        } catch(error)
        {
            this.setState({error})
        }
    }

    componentDidMount() {
        this.updateSample();
    }

    componentDidUpdate(prevProps) {
        if (prevProps !== this.props)
            this.updateSample();
    };

    render() {
        return (
            <ErrorBoundary error={this.state.error}>
                <ShowObject object={this.state.file} objectPresenterComponent={SamplePreviewPresenter}/>
            </ErrorBoundary>
        );
    }
}

export default ShowSamplePreview;
