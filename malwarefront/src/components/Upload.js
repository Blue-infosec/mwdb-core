import React, {Component} from 'react';
import Dropzone from 'react-dropzone';
import {FontAwesomeIcon} from '@fortawesome/react-fontawesome'

import Autocomplete from 'react-autocomplete';

import api from "@malwarefront/api";
import { View } from "@malwarefront/ui";

import { connect } from "react-redux";

class Upload extends Component {
    state = {
        files: null,
        error: null,
        success: null,
        shareWith: "default",
        group: "",
        groups: null
    }

    async updateGroups() {
        try {
            let response = await api.getShareInfo()
            let groups = response.data.groups;
            groups.splice(groups.indexOf("public"), 1)
            groups.splice(groups.indexOf(this.props.login), 1)
            this.setState({groups: groups, shareWith: groups.length > 0 ? "default" : "private"});
        } catch(error) {
            this.setState({error});
        }
    }

    componentDidMount() {
        this.updateGroups()
    }

    onDrop = (files) => {
        this.setState({
            file: files[0],
        });
    };

    updateSharingMode = (event) => {
        this.setState({ shareWith: event.target.value, group: "" })
    }

    sharingModeToUploadParam = () => {
        if(this.state.shareWith === "default")
            return "*";
        if(this.state.shareWith === "public")
            return "public";
        if(this.state.shareWith === "private")
            return this.props.login;
        if(this.state.shareWith === "single")
            return this.state.group;
    }

    getSharingModeHint = () => {
        if(this.state.shareWith === "default")
            return `The sample and all related artifacts will be shared with all your workgroups`
        if(this.state.shareWith === "public")
            return `The sample will be added to the public feed, so everyone will see it.`
        else if(this.state.shareWith === "private")
            return `The sample will be accessible only from your account.`
        else if(this.state.shareWith === "single")
            return `The sample will be accessible only for you and chosen group.`
    }

    handleSubmit = async () => {
        let fd = new FormData();
        fd.append('file', this.state.file);
        fd.append('upload_as', this.sharingModeToUploadParam())
        try {
            let response = await api.uploadFile(fd);
            this.sha256 = response.data.sha256;
            this.props.history.replace('/sample/' + this.sha256);
        } catch(error) {
            this.setState({error})
        }
    };

    render() {
        if(this.state.groups === null)
        {
            return <View error={this.state.error} success={this.state.success} />
        }
        return (
            <View ident="upload" error={this.state.error} success={this.state.success}>
                <form>
                    <Dropzone className="dropzone-ready dropzone"
                              activeClassName="dropzone-active"
                              rejectClassName="dropzone-reject"
                              onDrop={this.onDrop}>
                        <div className="card">
                            <div className="card-body">
                                <h5 className="card-title">
                                    <FontAwesomeIcon icon="upload" size="x"/>&nbsp;
                                    {
                                        this.state.file 
                                        ? <span>{this.state.file.name} - {this.state.file.size} bytes </span>
                                        : <span>Click here to upload</span>
                                    }
                                </h5>
                            </div>
                        </div>
                    </Dropzone>
                    <div className="form-group">
                        <div className="input-group mb-3">
                            <div className="input-group-prepend">
                                <label className="input-group-text">Share with</label>
                            </div>
                            <select className="custom-select" value={this.state.shareWith} onChange={this.updateSharingMode}>
                                {
                                    this.state.groups.length ? [
                                        <option value="default">All my groups</option>,
                                        <option value="single">Single group...</option>
                                    ]: []
                                }
                                <option value="public">Everybody</option>
                                <option value="private">Only me</option>
                            </select>
                            <div class="form-hint">{this.getSharingModeHint()}</div>
                        </div>
                        {
                            this.state.shareWith === "single"
                            ? (<div className="input-group mb-3">
                                <div className="input-group-prepend">
                                    <label className="input-group-text">Group name</label>
                                </div>
                                <Autocomplete
                                    value={this.state.group}
                                    inputProps={{id: 'states-autocomplete'}}
                                    getItemValue={(item) => item}
                                    shouldItemRender={(item, value) => {
                                        return (item.toLowerCase().indexOf(value.toLowerCase()) !== -1);
                                    }}
                                    items={this.state.groups}
                                    onChange={event => this.setState({group: event.target.value})}
                                    onSelect={value => this.setState({group: value})}
                                    renderInput={(props) =>
                                        <input {...props} className='form-control' placeholder="Type group name..."/>
                                    }
                                    wrapperStyle={{display:"block"}}
                                    renderMenu={children =>
                                        <div className={"dropdown-menu " + (children.length !== 0 ? "show" : "")}>
                                            {
                                                children.map(c =>
                                                    <a key={c} href="#dropdown" className="dropdown-item" style={{"cursor": "pointer"}}>
                                                        {c}
                                                    </a>
                                                )
                                            }
                                        </div>
                                    }
                                    renderItem={(item, isHighlighted) => (
                                        <div
                                            className={`item ${isHighlighted ? 'item-highlighted' : ''}`}
                                            key={item}
                                        >{item}</div>
                                    )}
                                />
                            </div>)
                            : []
                        }
                        <input value="Upload File" className="btn btn-success" type="button" 
                               onClick={this.handleSubmit} disabled={!this.state.file}/>
                    </div>
                </form>
            </View>
        );
    }
}

function mapStateToProps(state, ownProps)
{
    return {
        ...ownProps,
        login: state.auth.loggedUser.login
    }
}


export default connect(mapStateToProps)(Upload);
