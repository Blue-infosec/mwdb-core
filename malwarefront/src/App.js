import React, {Component} from 'react';
import { ConnectedRouter } from "connected-react-router";
import { bindActionCreators } from 'redux';
import { Switch, Route } from 'react-router-dom';
import { connect } from "react-redux";

import About from './components/About';
import Navigation from './components/Navigation';
import RecentConfigs from './components/RecentConfigs';
import RecentSamples from './components/RecentSamples';
import ConfigStats from './components/ConfigStats';
import RecentBlobs from './components/RecentBlobs';
import ShowSample from './components/ShowSample';
import ShowConfig from './components/ShowConfig';
import ShowTextBlob from './components/ShowTextBlob';
import DiffTextBlob from './components/DiffTextBlob';
import Upload from './components/Upload';
import UserLogin from './components/UserLogin';
import UserProfile from './components/UserProfile';
import ShowUsers from "./components/ShowUsers";
import ShowGroups from "./components/ShowGroups";
import UserCreate from "./components/UserCreate";
import UserRegister from "./components/UserRegister";
import UserUpdate from "./components/UserUpdate";
import GroupRegister from "./components/GroupRegister";
import GroupUpdate from "./components/GroupUpdate";
import UserSetPassword from "./components/UserSetPassword";
import ShowMetakeys from './components/ShowMetakeys';
import MetakeyDefine from './components/MetakeyDefine';
import MetakeyUpdate from './components/MetakeyUpdate';
import Search, { SearchHelp } from "./components/Search";
import RelationsPlot from './components/RelationsPlot';

import { library } from '@fortawesome/fontawesome-svg-core'
import { faTimes, faUpload, faDownload, faPlus, faMinus, faRandom, 
         faExchangeAlt, faBan, faSearch, faToggleOn, faToggleOff, faSort, faSortUp, faSortDown, faProjectDiagram, faFile, faFileImage, faFilePdf } from '@fortawesome/free-solid-svg-icons'
import ShowSamplePreview from './components/ShowSamplePreview';

import { configActions } from '@malwarefront/config';
import history from "@malwarefront/history";
import { ProtectedRoute, Extension, View } from "@malwarefront/ui";
import ShowPendingUsers from './components/ShowPendingUsers';

library.add(faTimes);
library.add(faUpload);
library.add(faDownload);
library.add(faPlus);
library.add(faMinus);
library.add(faRandom);
library.add(faExchangeAlt);
library.add(faBan);
library.add(faSearch);
library.add(faToggleOn);
library.add(faToggleOff);
library.add(faSort);
library.add(faSortUp);
library.add(faSortDown);
library.add(faProjectDiagram);
library.add(faFile);
library.add(faFileImage);
library.add(faFilePdf);

class App extends Component {
    componentDidMount() {
        this.props.configActions.init();
    }

    render() {
        const AuthenticatedRoute = (args) => (
            <ProtectedRoute condition={this.props.isAuthenticated} {...args} />
        )

        const AdministrativeRoute = (args) => (
            <ProtectedRoute condition={this.props.isAdmin} {...args} />
        )

        const AttributeRoute = (args) => (
            <ProtectedRoute condition={this.props.isAttributeManager} {...args} />
        )

        return (
            <ConnectedRouter history={history}>
                <div className="App">
                    <Navigation isAuthenticated={this.props.isAuthenticated} 
                                isAdmin={this.props.isAdmin} 
                                isAttributeManager={this.props.isAttributeManager}
                                hasBlobAccess={this.props.hasBlobAccess}/>

                    <div className="content">
                        <View fluid ident="main" style={{"padding": "0"}} {...this.props}>
                            {
                                this.props.config !== null
                                ? <Switch>
                                    <Route exact path='/login' component={UserLogin} />
                                    {
                                        this.props.config["is_registration_enabled"]
                                        ? <Route exact path="/register" component={UserRegister} />
                                        : []
                                    }
                                    <Route exact path='/setpasswd/:token' component={UserSetPassword} />
                                    <AuthenticatedRoute exact path='/' component={RecentSamples} />
                                    <AuthenticatedRoute exact path='/about' component={About} />
                                    <AuthenticatedRoute exact path='/profile' component={UserProfile} />
                                    <AuthenticatedRoute exact path='/configs' component={RecentConfigs} />
                                    <AuthenticatedRoute exact path='/configs/stats' component={ConfigStats} />
                                    <AuthenticatedRoute exact path='/upload' component={Upload} />
                                    <AuthenticatedRoute path='/sample/:hash' component={ShowSample} />
                                    <AuthenticatedRoute path='/preview/:mode/:hash' component={ShowSamplePreview} />
                                    <AuthenticatedRoute path='/config/:hash' component={ShowConfig} />
                                    <AuthenticatedRoute path='/search' component={Search} />
                                    <AuthenticatedRoute path='/search_help' component={SearchHelp} />
                                    <AuthenticatedRoute path='/relations' component={RelationsPlot} />
                                    <AdministrativeRoute exact path="/user/:login" component={UserUpdate} />
                                    <AdministrativeRoute exact path="/users" component={ShowUsers} />
                                    <AdministrativeRoute exact path="/users/pending" component={ShowPendingUsers} />
                                    <AdministrativeRoute exact path="/users/new" component={UserCreate} />
                                    <AdministrativeRoute exact path="/groups" component={ShowGroups} />
                                    <AdministrativeRoute exact path="/groups/new" component={GroupRegister} />
                                    <AdministrativeRoute exact path="/group/:name" component={GroupUpdate} />
                                    <AttributeRoute exact path="/attribute/:metakey" component={MetakeyUpdate}/>
                                    <AttributeRoute exact path="/attributes" component={ShowMetakeys}/>
                                    <AttributeRoute exact path="/attributes/new" component={MetakeyDefine}/>
                                    <AuthenticatedRoute exact path='/blobs' component={RecentBlobs} />
                                    <AuthenticatedRoute path='/blob/:hash' component={ShowTextBlob} />
                                    <AuthenticatedRoute path='/diff/:current/:previous' component={DiffTextBlob} />
                                    <Extension ident="routes" {...this.props}/>
                                </Switch>
                                : []
                            }
                        </View>
                    </div>
                </div>
            </ConnectedRouter>
        );
    }
}

function mapStateToProps(state, ownProps)
{
    return {
        ...ownProps,
        error: state.config.error,
        config: state.config.config,
        isAuthenticated: !!state.auth.loggedUser,
        isAdmin: state.auth.loggedUser && state.auth.loggedUser.capabilities.indexOf("manage_users") >= 0,
        isAttributeManager: state.auth.loggedUser && state.auth.loggedUser.capabilities.indexOf("managing_attributes") >= 0,
    }
}

function mapDispatchToProps(dispatch) {
    return {
        configActions: bindActionCreators(configActions, dispatch)
    }
}

export default connect(mapStateToProps, mapDispatchToProps)(App);
